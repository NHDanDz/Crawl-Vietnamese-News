<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Scraper</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Thêm CSS của flatpickr và theme -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/material_blue.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/vn.js"></script>
    <style>
        .article-card {
            height: 100%;
            transition: transform 0.2s;
        }
        .article-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center; 
            z-index: 1000;
        }
        .search-bar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
            padding: 1rem 0;
            border-bottom: 1px solid #eee;
        }
        .filter-section {
            display: none;
        }
        .filter-section.show {
            display: block;
        }
        #searchResults {
            margin-top: 2rem;
        } 
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4 text-center">Vietnamese News Scraper</h2>

        <!-- Search Bar -->
        <div class="search-bar mb-4">
            <div class="row">
                <div class="col-md-8 mx-auto">
                    <div class="input-group">
                        <input type="text" id="searchInput" class="form-control" 
                               placeholder="Search news articles...">
                        <button class="btn btn-primary" type="button" onclick="searchNews()">
                            Search
                        </button>
                        <button class="btn btn-outline-secondary" type="button" 
                                onclick="toggleFilters()">
                            Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="card mt-4 filter-section" id="filterSection">
            <div class="card-body">
                <form id="scraperForm" onsubmit="return false;">
                    <!-- Date Range Picker -->
                    <div class="mb-4">
                        <h5>Select Date Range:</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <input type="text" id="dateRange" class="form-control" placeholder="Select dates..." readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Sources Selection -->
                    <div class="mb-4">
                        <h5>Select News Sources:</h5>
                        <div class="row">
                            {% for source in sources %}
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           name="sources" value="{{ source.name }}" 
                                           id="source{{ source.id }}">
                                    <label class="form-check-label" for="source{{ source.id }}">
                                        {{ source.name }}
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Topics Selection -->
                    <div class="mb-4">
                        <h5>Select Topics:</h5>
                        <div class="row">
                            {% for topic in topics %}
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           name="topics" value="{{ topic }}" 
                                           id="topic{{ loop.index }}">
                                    <label class="form-check-label" for="topic{{ loop.index }}">
                                        {{ topic }}
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="text-center">
                        <button type="button" class="btn btn-primary px-4" onclick="collectNews()">
                            Collect News
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results">
            <div id="loadingSpinner" class="loading-overlay" style="display: none;">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2" id="loadingText">Processing...</div>
                </div>
            </div>
            <div id="searchResults" class="mb-4"></div>
            <div id="articlesContainer" class="row mt-4"></div>
        </div>

        <!-- Debug Section -->
        <div class="card mt-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">Debug Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Request Data:</h6>
                        <pre id="requestDebug" class="bg-light p-2 rounded"></pre>
                    </div>
                    <div class="col-md-6">
                        <h6>Response Data:</h6>
                        <pre id="responseDebug" class="bg-light p-2 rounded"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Initialize when document is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize flatpickr
            flatpickr("#dateRange", {
                mode: "range",
                dateFormat: "d/m/Y",
                locale: "vn",
                maxDate: "today"
            });
        });
        
        // Toggle filters section visibility
        function toggleFilters() {
            const filterSection = document.getElementById('filterSection');
            filterSection.classList.toggle('show');
        } 
        
        
        function collectNews() {
            // Show loading spinner
            document.getElementById('loadingSpinner').style.display = 'block';
            
            // Get selected values
            const selectedSources = Array.from(document.querySelectorAll('input[name="sources"]:checked'))
                .map(cb => cb.value);
            const selectedTopics = Array.from(document.querySelectorAll('input[name="topics"]:checked'))
                .map(cb => cb.value);
        
            // Get dates from flatpickr
            const dateRangeInput = document.querySelector("#dateRange");
            const dateRangeValue = dateRangeInput.value; // Get the selected dates string
            const dates = dateRangeValue.split(" đến "); // Split the date range string
        
            // Convert dates from dd/mm/yyyy to yyyy-mm-dd format
            const fromDate = dates[0] ? convertDate(dates[0].trim()) : null;
            const toDate = dates[1] ? convertDate(dates[1].trim()) : fromDate;
        
            // Prepare request data
            const requestData = {
                sources: selectedSources,
                topics: selectedTopics,
                fromdate: fromDate,
                todate: toDate
            };
        
            console.log('Request Data:', requestData); // Debug log
        
            // Show request data in debug section
            document.getElementById('requestDebug').textContent = JSON.stringify(requestData, null, 2);
        
            // Send request
            fetch('/collect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading spinner
                document.getElementById('loadingSpinner').style.display = 'none';
                
                // Show response data in debug section
                document.getElementById('responseDebug').textContent = JSON.stringify(data, null, 2);
                
                if (data.success) {
                    displayArticles(data.data);
                } else {
                    console.error('Error response:', data); // Debug log
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                // Hide loading spinner
                document.getElementById('loadingSpinner').style.display = 'none';
                console.error('Error:', error);
                alert('Error: ' + error);
            });
        }
        
        // Helper function to convert date from dd/mm/yyyy to yyyy-mm-dd
        function convertDate(dateStr) {
            const [day, month, year] = dateStr.split('/');
            return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }
        // Function to search news
        function searchNews() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('Please enter a search term');
                return;
            }
        
            const sources = [...document.querySelectorAll('input[name="sources"]:checked')]
                .map(cb => cb.value);
            const topics = [...document.querySelectorAll('input[name="topics"]:checked')]
                .map(cb => cb.value);
        
            const loadingSpinner = document.getElementById('loadingSpinner');
            const searchResults = document.getElementById('searchResults');
            
            loadingSpinner.style.display = 'block';
            searchResults.innerHTML = '';
        
            // Update debug info
            document.getElementById('requestDebug').textContent = 
                JSON.stringify({ query, sources, topics }, null, 2);
        
            fetch('/search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query: query,
                    sources: sources.length ? sources : undefined,
                    topics: topics.length ? topics : undefined
                })
            })
            .then(response => response.json())
            .then(result => {
                // Update debug info
                document.getElementById('responseDebug').textContent = 
                    JSON.stringify(result, null, 2);
        
                if (result.success && result.data) {
                    if (result.data.length === 0) {
                        searchResults.innerHTML = `
                            <div class="alert alert-info">
                                No articles found matching your search criteria
                            </div>
                        `;
                    } else {
                        searchResults.innerHTML = `
                            <div class="alert alert-success">
                                Found ${result.data.length} matching articles
                            </div>
                        `;
                        displayArticles(result.data);
                    }
                } else {
                    throw new Error(result.error || 'Search failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                searchResults.innerHTML = `
                    <div class="alert alert-danger">
                        Search error: ${error.message}
                    </div>
                `;
            })
            .finally(() => {
                loadingSpinner.style.display = 'none';
            });
        }
        
        // Function to display articles
        function displayArticles(articles) {
            const container = document.getElementById('articlesContainer');
            container.innerHTML = '';
        
            articles.forEach(article => {
                const articleDiv = document.createElement('div');
                articleDiv.className = 'col-md-4 mb-4';
                
                articleDiv.innerHTML = `
                    <div class="card article-card">
                        <div class="card-body">
                            <h5 class="card-title">${escapeHtml(article.title)}</h5>
                            <p class="card-text description">${escapeHtml(article.description || '')}</p>
                            <div class="mt-3">
                                <p class="text-muted mb-2 small">
                                    <strong>Source:</strong> ${escapeHtml(article.source)}<br>
                                    <strong>Topic:</strong> ${escapeHtml(article.topic || 'N/A')}<br>
                                    <strong>Date:</strong> ${escapeHtml(article.date || 'N/A')}
                                </p>
                                <a href="${escapeHtml(article.link)}" 
                                   target="_blank" 
                                   class="btn btn-primary btn-sm">Read More</a>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(articleDiv);
            });
        }
        
        // Utility function to escape HTML
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        </script>
</body>
</html>